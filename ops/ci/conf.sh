#!/bin/bash

# The entrypoint executes any /docker-entrypoint-initdb.d/*.{sh,sql} files.
# Drop this script into that directory in the official Postgres Docker image.

sed -i 's/#ssl = off/ssl = on/' /var/lib/postgresql/data/postgresql.conf
sed -i 's/#ssl_cert_file/ssl_cert_file/' /var/lib/postgresql/data/postgresql.conf
sed -i 's/#ssl_key_file/ssl_key_file/' /var/lib/postgresql/data/postgresql.conf

# These are only for testing, it's fine to check them into the repo
echo -e "-----BEGIN CERTIFICATE-----\nMIIC0DCCAbigAwIBAgIUY5B4VPYtD6IfcTijtTP6Gc5J5/EwDQYJKoZIhvcNAQEL\nBQAwETEPMA0GA1UEAwwGdWJ1bnR1MB4XDTIwMDQyNTE5NDEzNVoXDTMwMDQyMzE5\nNDEzNVowETEPMA0GA1UEAwwGdWJ1bnR1MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A\nMIIBCgKCAQEApfjHLuaLtZyRTLXRMZKgTZD3GCNLGQdlxT1b9CWLHaJgaPWMY3Us\nLkHFf3igjWdTghLEg8NLLB3fUXIoADXG4IIuNoJ7hNbmcs/KHkHzXslpz9CTbfs5\nNan65JAaSo9m+lb+OUWGcIsccLZJScuh8sSM7QCvrMxBhssBZQ4rJgGXGwuETmXz\nUcK9hgpbDxl7Bca+dNyRZ51uidmybqcX5vEd4GFhjw4Ne+DNIbJ80EYYUG8g/F2K\nPMJ/44HY2Z9t/CYgPfq0i5YESGYW55+G5wsgEyyMnbU/KzlOvQC9bNQRsafgno63\nbJVwfGU1x2/NL0j4S+qGu+lT9Pwh8UcYnwIDAQABoyAwHjAJBgNVHRMEAjAAMBEG\nA1UdEQQKMAiCBnVidW50dTANBgkqhkiG9w0BAQsFAAOCAQEASkJLiJSNVwLtyyR5\nKDDCTVXPKL3mAYKzRU8WA/vjY3p74flfG+2K5ZTXclkUhCvBLgbCsuQK5s+bUq0V\nUGXt/ow5dNFBmmbkXZm+7JL3xNWekoYP9D+gaLvdUyV702472b/Y7odhFPgHmu49\nmgcSBxfJNn3+mWRZe87A3JQrLSm0ua9NpEBuSxdbqIUQVmqlWoaEfzxBM4RUWoWP\nZTQqwMGKWg3HV1mVANjMCUsnIBhO29EKQhXk+YMK+jLuz4mnFo6cXPBAEQ5z5VN1\n29ZcTFgGgYARWu37DYcoURoPlolDwlztYtktg3MiQA7xPepLVBWghwMVKSXGCaIE\nWqR1Xg==\n-----END CERTIFICATE-----" > /var/lib/postgresql/data/server.crt
echo -e "-----BEGIN PRIVATE KEY-----\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQCl+Mcu5ou1nJFM\ntdExkqBNkPcYI0sZB2XFPVv0JYsdomBo9YxjdSwuQcV/eKCNZ1OCEsSDw0ssHd9R\ncigANcbggi42gnuE1uZyz8oeQfNeyWnP0JNt+zk1qfrkkBpKj2b6Vv45RYZwixxw\ntklJy6HyxIztAK+szEGGywFlDismAZcbC4ROZfNRwr2GClsPGXsFxr503JFnnW6J\n2bJupxfm8R3gYWGPDg174M0hsnzQRhhQbyD8XYo8wn/jgdjZn238JiA9+rSLlgRI\nZhbnn4bnCyATLIydtT8rOU69AL1s1BGxp+CejrdslXB8ZTXHb80vSPhL6oa76VP0\n/CHxRxifAgMBAAECggEACFy+fGh1RZM75ueKQLsohH/3UyoEEKDEyelLhsOVfMq/\nnMoyZphyv2nk74U+YaGBHZ6gdBsU4IYoyEu+JDSRbqJgfbKZUpoZRlOd1WRxRKdV\nQ3k41GPCACguUfHIwVT0VUyoxm3wVh9MMYmdq7As2rR4fUB5mXU5H/d+fH74QZPi\nKR5sg2daChcgpn8cTos7e87nlPqt6rf/eYpI2qdPkXviyK3Ys+uvRYAVpRSXmtey\nIpEW2h7gpYgjwikTj8uaFZnGsaUfGbpwgLRbYLlxpWJNWzndu7VNNlp8EINUr2wd\nuQaA5ILiVIbaRuRf5BpWD6MOkWAXNpy5KFczCfYPEQKBgQDRJ1v7450PB8v3nQ/c\nlxNALZQ17QULEWAeoBz7UYqd1QfcMrz7IqhpqR1Vs9fN2ogMPoPcVgdgsZ6k7on5\nfiRTErW7MXKWtAcHVYPhmCZPQUc4BnmzJc/pp3ehwxGwo43Avpeg2jYTOvo4HJYa\ntH8EFWnqYrCDXlDT5G1k6HlhPQKBgQDLJWnwyMKT23j2yEemgB+Aiixg2EvnS2Rf\nJPzg6BGbCR19fJhagIZDwDThPjuyQozRcBldhSzbhJESIlXb4OUsfsUwOB3/2Zwm\nal3IYE+iG5zt+nZNfACNhGZ4LezJRx6IXx78ZLFskuQI8kmyECHFYbs4XQDoBV90\n+R2/4/hHCwKBgQCIWuanEz9Dm0uohKbgo0WTo6NqfLm6+3r0vGHonsKGH2pebl2y\nRGgTaoOLahIZTI1BnkgND7EDowjQcgtVsp0v45TDE3unMHsclu3B15WyOdaaee5B\nkzc3F0zxEuGnjRlPPXJRFbIHW33hsxFRG7drDCLfAbQeEREU82k2TjFD6QKBgQC7\nTbHSaqjNP0zW7W7y26swDzY/zO6fQeo3t5jZnd+tvMfODfVDbMFe8ndPPtw3zhic\neulISyRC+oXv3GyhoUhssC4L+ZHfdrr8yJHT0MlbxG37FjXB15WC5hK8uEtcghBq\n2JlvSUA1xXIvtYWxgiJBJY1DuKy/QUT0S0Tcysr+ZQKBgQCL/9R0gCdMvvMH1yL3\nC5hg6SX7jgiNN0PaK1uK3RbL7N+RbfkdP4idgmX8NZUf61qeP0nN45tUfuikXv9M\nW4ArSw5khTG3qhxLU6cD2y8o80mrBMjv7NFjLMJZz0CuahWDlkMa1WebGXSyheOt\nIMeQhIlb9oleorXRHDZRasz7SA==\n-----END PRIVATE KEY-----" > /var/lib/postgresql/data/server.key
chmod 400 /var/lib/postgresql/data/server.key